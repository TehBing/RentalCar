CREATE OR REPLACE FUNCTION ListCustomerOrders(customerNumber IN NUMBER)
RETURN VARCHAR2 IS
    result VARCHAR2(4000);
BEGIN
    SELECT 
        'Customer#' || TO_CHAR(customer.c_custkey, 'FM000000000') || ' ' || customer.c_name || ': ' ||
        COALESCE(LISTAGG(orders.o_orderkey, ', ') WITHIN GROUP (ORDER BY orders.o_orderkey), 'No orders')
    INTO result
    FROM customer
    LEFT JOIN orders ON customer.c_custkey = orders.o_custkey
    WHERE customer.c_custkey = customerNumber
    GROUP BY customer.c_custkey, customer.c_name;
    
    RETURN result;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 'Customer#' || TO_CHAR(customerNumber, 'FM000000000') || ' does not exist';
    WHEN OTHERS THEN
        RETURN 'An error occurred';
END ListCustomerOrders;
/
